# 摇篮留言服务系统 - 技术架构

## 系统概述

摇篮留言服务系统是一个基于Flask的Web应用，用于安全、可靠地存储和定时发送用户留言。系统支持多级预警机制，确保用户可以灵活控制留言的最终发送。

## 技术栈

### 后端

- **Web框架**: Flask 3.1.0
- **ORM**: SQLAlchemy 2.0.39 (Flask-SQLAlchemy 3.1.1)
- **数据库**: MySQL (通过PyMySQL 1.1.1)
- **认证**: Flask-Login 0.6.3, Flask-JWT-Extended 4.7.1
- **任务调度**: APScheduler 3.11.0 (Flask-APScheduler 1.13.1)
- **加密**: Cryptography 44.0.2
- **日志**: 标准Python日志系统

### 前端

- **模板引擎**: Jinja2 3.1.6
- **CSS框架**: 原生CSS
- **JavaScript**: 原生JavaScript

## 系统架构

### 模块结构

```
摇篮留言服务系统
├── 用户认证模块
│   ├── 登录管理
│   ├── 会话控制
│   └── JWT认证
├── 留言管理模块
│   ├── 留言创建
│   ├── 留言存储
│   ├── 留言撤销
│   └── 接收人管理
├── 预警系统模块
│   ├── 预警计算
│   ├── 预警发送
│   └── 预警响应处理
├── 任务调度模块
│   ├── 任务创建
│   ├── 任务执行
│   └── 任务监控
└── 管理后台模块
    ├── 数据统计
    ├── 系统监控
    └── 用户管理
```

### 数据库设计

#### User (用户)
- `id`: Integer, 主键
- `username`: String(80), 用户名，唯一
- `email`: String(120), 邮箱，唯一
- `password`: String(120), 密码
- `created_at`: DateTime, 创建时间

#### Message (留言)
- `id`: Integer, 主键
- `user_id`: Integer, 外键，关联User
- `content`: Text, 留言内容
- `created_at`: DateTime, 创建时间
- `initial_delay_months`: Integer, 初始延迟月数
- `next_warning_date`: DateTime, 下次预警日期
- `warning_level`: Integer, 预警级别（0-5）
- `is_active`: Boolean, 是否有效
- `revocation_key`: String(255), 撤销密钥，唯一

#### Recipient (接收人)
- `id`: Integer, 主键
- `message_id`: Integer, 外键，关联Message
- `name`: String(100), 接收人姓名
- `contact`: String(100), 联系方式
- `contact_type`: String(20), 联系方式类型

#### StatusLog (状态日志)
- `id`: Integer, 主键
- `message_id`: Integer, 外键，关联Message
- `status`: String(50), 状态
- `created_at`: DateTime, 创建时间
- `details`: Text, 详细信息
- `response`: String(20), 响应类型

### 关系图

```
User 1--* Message
Message 1--* Recipient
Message 1--* StatusLog
```

## 核心功能实现

### 留言创建与撤销

留言创建过程包括：
1. 接收用户提交的留言内容和接收人信息
2. 验证数据合法性
3. 计算预警时间表
4. 生成唯一的撤销密钥
5. 保存留言和接收人信息到数据库
6. 返回撤销密钥和预警时间表给用户

撤销机制通过唯一的撤销密钥实现，任何拥有撤销密钥的人都可以撤销留言，无需登录认证。

### 预警机制

系统实现了五级预警机制，具体流程如下：
1. 初始延迟期（用户设定的月数）
2. 第一级预警（等待30天）
3. 第二级预警（等待30天）
4. 第三级预警（等待7天）
5. 第四级预警（等待1天）
6. 最终预警（准备发送留言）

用户在收到预警通知后有两种选择：
- 重置预警周期：将预警级别重置为0，重新开始预警周期
- 继续预警流程：预警级别提升，进入下一级预警

### 安全机制

1. **数据加密**
   - 使用Cryptography库的Fernet对称加密算法
   - 敏感数据在存储前加密

2. **认证授权**
   - 基于Flask-Login的会话认证，用于Web界面访问
   - 基于JWT的API认证，用于API接口访问

3. **撤销机制**
   - 生成唯一的撤销密钥，使用base64编码存储
   - 通过撤销密钥可以随时禁用留言

## 系统流程

### 留言创建流程

```
用户 -> 填写留言表单 -> 提交留言 -> 服务器验证 -> 生成撤销密钥 -> 计算预警时间表 -> 存储留言 -> 返回撤销密钥和预警时间表 -> 用户
```

### 预警处理流程

```
系统 -> 检查预警日期 -> 发送预警通知 -> 用户响应 -> 系统处理响应 -> 更新预警状态
```

### 留言撤销流程

```
用户 -> 提供撤销密钥 -> 服务器验证 -> 标记留言为无效 -> 记录状态变更 -> 返回成功消息 -> 用户
```

## 配置管理

系统配置通过`config/config.py`文件管理，主要配置项包括：

- 数据库连接
- 密钥设置
- JWT设置
- 文件上传设置
- 日志设置
- 预警时间间隔设置
- 管理员账户设置
- 加密设置

## 部署架构

系统采用标准的Flask应用部署架构：

```
客户端 -> Web服务器(Nginx) -> WSGI服务器(Gunicorn) -> Flask应用 -> 数据库服务器(MySQL)
```

## 安全考虑

1. 密码安全
   - 在实际生产环境中应使用密码哈希（如bcrypt）

2. HTTPS传输
   - 生产环境应配置SSL证书，强制使用HTTPS

3. 访问控制
   - 基于角色的访问控制
   - API请求限流

4. 数据保护
   - 敏感数据加密存储
   - 定期数据备份

## 扩展性考虑

1. 微服务架构
   - 将不同功能模块拆分为独立服务
   - 使用消息队列实现服务间通信

2. 数据库扩展
   - 读写分离
   - 分库分表

3. 高可用部署
   - 多实例部署
   - 负载均衡

## 性能优化

1. 数据库优化
   - 适当索引
   - 查询优化

2. 缓存策略
   - 使用Redis缓存热点数据

3. 任务异步处理
   - 使用APScheduler处理耗时任务 